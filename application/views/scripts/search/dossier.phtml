<!-- Traitement pour l'affichage des dates -->
<?php
    $dateCreationStart="";
    if(isset($_GET["date-creation-start"])){
        $dateArray = explode('/', $_GET["date-creation-start"]);
        $dateCreationStart = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
    
    $dateCreationEnd="";
    if(isset($_GET["date-creation-end"])){
        $dateArray = explode('/', $_GET["date-creation-end"]);
        $dateCreationEnd = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
    
    $dateReceptionStart="";
    if(isset($_GET["date-reception-start"])){
        $dateArray = explode('/', $_GET["date-reception-start"]);
        $dateReceptionStart = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
    
    $dateReceptionEnd="";
    if(isset($_GET["date-reception-end"])){
        $dateArray = explode('/', $_GET["date-reception-end"]);
        $dateReceptionEnd = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
    
    $dateReponseStart="";
    if(isset($_GET["date-reponse-start"])){
        $dateArray = explode('/', $_GET["date-reponse-start"]);
        $dateReponseStart = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
    
    $dateReponseEnd="";
    if(isset($_GET["date-reponse-end"])){
        $dateArray = explode('/', $_GET["date-reponse-end"]);
        $dateReponseEnd = $dateArray[1]."/".$dateArray[0]."/".$dateArray[2];
    }
?>

<!-- Onglets permettant de selectionner les entités à rechercher -->
<h2 class="page-header">Dossiers</h2>
<form method='get' class='row-fluid'>

	<div class='navbar-form form-search well well-small span12' style='margin-bottom: 5px;'>
		<div class="input-append span6 offset3">
			<input type="text" name='objet' class="search-query" placeholder="Objet du dossier ..." value='<?php if(isset($_GET["objet"])) echo $_GET["objet"] ?>' />
			<input type='submit' class="btn" value="Rechercher dans Prevarisc"  />
			<input type='hidden' name='page' value="1" />
		</div>
	</div>
        
        
    
    <div id='filterContainer' class='well span12' style="margin-left: 0;">
            <div class='row-fluid'>
                <select name='types[]' class="span3 chosen" data-placeholder='Types' multiple>
                    <?php foreach( $this->DB_type as $type ) : ?>
                        <option value='<?php echo $type["ID_DOSSIERTYPE"] ?>' <?php if(isset($_GET["types"]) && in_array($type["ID_DOSSIERTYPE"], (array) $_GET["types"])) echo 'selected' ?>><?php echo $type["LIBELLE_DOSSIERTYPE"] ?></option>
                    <?php endforeach ?>
                </select>
                <select name='commissions[]' class="span3 chosen" data-placeholder='Commissions' multiple>
                    <?php
                        foreach($this->array_commissions as $array_commission){
                            echo "<optgroup label='".htmlspecialchars($array_commission["LIBELLE"], ENT_QUOTES)."' >";
                            foreach($array_commission["ARRAY"] as $item){
                                    echo "<option value='".$item["ID_COMMISSION"]."'";
                                    if(isset($_GET["commissions"]) && in_array($item["ID_COMMISSION"], (array) $_GET["commissions"])) echo 'selected';        
                                    echo " >".htmlspecialchars($item["LIBELLE_COMMISSION"], ENT_QUOTES)."</option>";
                            }
                            echo "</optgroup>";
                        }

                    ?>
                </select>
                <select name='avisCommission[]' class="span3 chosen" data-placeholder='Avis de la commission' multiple>
                                    <option value='1' <?php if(isset($_GET["avisCommission"]) && in_array(1, (array) $_GET["avisCommission"])) echo 'selected' ?>>Favorable</option>
                                    <option value='2' <?php if(isset($_GET["avisCommission"]) && in_array(2, (array) $_GET["avisCommission"])) echo 'selected' ?>>Défavorable</option>
                </select>
                <select name='avisRapporteur[]' class="span3 chosen" data-placeholder='Avis du rapporteur' multiple>
                                    <option value='1' <?php if(isset($_GET["avisRapporteur"]) && in_array(1, (array) $_GET["avisRapporteur"])) echo 'selected' ?>>Favorable</option>
                                    <option value='2' <?php if(isset($_GET["avisRapporteur"]) && in_array(2, (array) $_GET["avisRapporteur"])) echo 'selected' ?>>Défavorable</option>
                </select>
            </div>
            <div class='row-fluid span12'>
            </div>
            <div class='row-fluid'> 
                <div class='span4'>
                    <select name='commune' class="span12 chosen" data-placeholder='Types'>
                        <option value=''>Sélectionnez une commune</option>
                    <?php foreach( $this->array_communes as $commune ) : ?>
                        <option value='<?php echo $commune["NUMINSEE_COMMUNE"] ?>' <?php if(isset($_GET["commune"]) && $commune["NUMINSEE_COMMUNE"] == $_GET["commune"]) echo 'selected' ?>><?php echo $commune["LIBELLE_COMMUNE"] ?></option>
                    <?php endforeach ?>
                    </select>
                </div>
                <div class='span3'>
                    <select name='voie' class="span12 chosen" data-placeholder='Types'>
                        <option value=''>Sélectionnez une voie</option>
                        <?php foreach( $this->array_voies as $voie ) : ?>
                            <option value='<?php echo $voie["ID_RUE"] ?>' <?php if(isset($_GET["voie"]) && $voie["ID_RUE"] == $_GET["voie"]) echo 'selected' ?>><?php echo $voie["LIBELLE_RUE"] ?></option>
                        <?php endforeach ?>
                    </select>
                    <script>
                        
                    </script>
                </div>
                <div class='span5'>
                    <span class='span1'>&nbsp;</span>
                    <span class=span2>Création</span>
                    <span class=span1>du&nbsp;</span>
                    
                    
                    <input type='text' name='date-creation-start' value='<?php echo $dateCreationStart ?>' class='datepicker span3'>
                    &nbsp;au&nbsp;
                    <input type='text' name='date-creation-end' value='<?php echo $dateCreationEnd ?>' class='datepicker span3'>
                </div>
            </div>
            <div class='row-fluid'> 
                <div class='span4'>
                    <input type="text" name='permis' class='span12' value='<?php echo isset($_GET["permis"])?$_GET["permis"]:'' ?>' placeholder="Numéro de permis" />
                </div>
                <div class='span3'>&nbsp;</div>
                <div class='span5'>
                    <span class='span1'>&nbsp;</span>
                    <span class=span2>Réception</span>
                    <span class=span1>du&nbsp;</span>
                    <input type='text' name='date-reception-start' value='<?php echo $dateReceptionStart ?>' class='datepicker span3' >
                    &nbsp;au&nbsp;
                    <input type='text' name='date-reception-end' value='<?php echo $dateReceptionEnd ?>' class='datepicker span3' >
                </div>
            </div>
            <div class='row-fluid'> 
                <div class='span4'>
                    <select name="preventionniste" class='span12 chosen' placeholder_text_single='Préventionniste'>
                        <option value=''>Sélectionnez un préventionniste</option>
                        <?php foreach( $this->liste_prev as $prev ) : ?>
                        <option value='<?php echo $prev["ID_PREVENTIONNISTE"] ?>' <?php if(isset($_GET["preventionniste"]) && $prev["ID_PREVENTIONNISTE"] == $_GET["preventionniste"]) echo 'selected' ?>><?php echo $prev["NOM_UTILISATEURINFORMATIONS"]." ".$prev["PRENOM_UTILISATEURINFORMATIONS"] ?></option>
                        <?php endforeach ?>
                    </select>
                </div>
                <div class='span3'>&nbsp;</div>
                <div class='span5'>
                    <span class='span1'>&nbsp;</span>
                    <span class=span2>Réponse</span>
                    <span class=span1>du&nbsp;</span>
                    <input type='text' name='date-reponse-start' value='<?php echo $dateReponseStart ?>' class='datepicker span3' >
                    &nbsp;au&nbsp;
                    <input type='text' name='date-reponse-end' value='<?php echo $dateReponseEnd ?>' class='datepicker span3' >
                </div>
            </div>
        </div>
</form>



<?php if( count($this->results) > 0 ) : ?>
    <p class='muted'><small>Nombre total d'éléments : <?php echo $this->results->getTotalItemCount() ?></small></p>
    
    <table class='table table-condensed'>
        <tr>
            <th>Etablissement</th>
            <th>Objet</th>
            <th>Date</th>
            <th>Préventionnistes</th>
            <th>Pièces jointes</th>
        </tr>
        <?php echo $this->partialLoop('search/results/dossierTab.phtml', $this->results ) ?>
    </table>
    <br/>
    <div style='clear: both'></div>
    <?php echo $this->results ?>
<?php else : ?>
	<p class='muted'><small>Aucun résultat disponible.</small></p>
    <h2 style='color: silver; text-align: center;' ></h2>
<?php endif ?>

<script>
    $(document).ready(function() {

    	// Si le champ de recherche est vide, on empêche l'envoi d'une recherche
    	$("input[name='num_doc_urba']").focus().keyup(function() {$('input[type="submit"]').attr('disabled', $(this).val() == '')}).keyup();

	// Gestion des select et multiselect
        $(".chosen").chosen();

      // Affichage des dossiers enfants
      $("ul.recherche_liste li.slide").live("click", function() {
          var container = this;
          if( $(this).hasClass("active") ) {
              $(this).next().slideUp(400, function() {$(container).next().remove()});
              $(this).toggleClass("active");
          }
          else {
              $(container).find(".load").show();
              $.getJSON("/api/1.0/search/dossiers", {parent: $(this).attr("id"), count: 100}, function(data) {
                  $(container).toggleClass("active").find(".load").hide();
                  $.post("/search/display-ajax-search", {items: 'dossier', data: data.response.results}, function(html) {
                      $(container).after("<li class='ui-helper-hidden' >" + html + "</li>").next().slideDown();
                  });
              });
          }
      });
      
        $('select[name=commune]').change(function(){
            var selectedValue = $(this).val()
            if (selectedValue != ""){
                $.ajax({
                    url: "/api/1.0/adresse/get_voies",
                    type: 'post',
                    data: {
                        code_insee: selectedValue
                    },
                    success: function (result) {
                        voies = [];
                        var selectVoie = $('select[name=voie]');
                        selectVoie.empty();
                        selectVoie.append("<option value=''>Sélectionnez une voie</option>");
                        $.each(result.response, function (i, voie) {
                            selectVoie.append($("<option></option>")
                                .attr("value",voie.ID_RUE).text(voie.LIBELLE_RUE));
                        });
                        $('.chosen').trigger("chosen:updated");
                    }
                });
            }
        });
      
        
        
        
        $(".datepicker[name='date-creation-start']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-creation-end']" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $(".datepicker[name='date-creation-end']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-creation-start']" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $(".datepicker[name='date-reception-start']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-reception-end']" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $(".datepicker[name='date-reception-end']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-reception-start']" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        $(".datepicker[name='date-reponse-start']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-reponse-end']" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $(".datepicker[name='date-reponse-end']").datepicker({
            changeMonth: true,
            onClose: function( selectedDate ) {
                $( ".datepicker[name='date-reponse-start']" ).datepicker( "option", "maxDate", selectedDate );
            }
        });
        
        $(".datepicker").datepicker("option",{
            dateFormat:"dd/mm/yy",
            monthNames: ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"],
            dayNamesMin: ["Di","Lu","Ma","Me","Je","Ve","Sa"],
            firstDay: 1
        });
        
        
        $("i.icon-share").click(function(){
            var rowvalue = $(this).attr('id').substring(6);
            $('#rowpj'+rowvalue).toggle();
        });
                        
    });
</script>